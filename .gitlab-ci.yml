stages:
  - build
  - deploy

default:
  tags:
    - vanilla
  id_tokens: # Support for id_tokens introduced in GitLab 16.4. Dec 6 according to devtools
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.scania.com
  retry: 1

variables:
  NODE_VERSION: "18"

before_script:
  - apt-get update -qq && apt-get install -y -qq git curl
  - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
  - apt-get install -y nodejs
  - npm install -g @aws-amplify/cli@latest

build:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

deploy:
  stage: deploy
  script:
    - npx ampx deploy --branch main
  environment:
    name: production
    url: https://s3.clad-playground.devtest.aws.scania.com
  only:
    - main