include:
  - local: gitlab-ci-template.yml

image: node:18-bullseye

variables:
  PROFILE_NAME: default
  ACCOUNT_ID: 134143989055
  DEPLOY_ROLE_NAME: team-account-deploy-role
  PARTITION: aws
  REGION: eu-north-1
  DEPLOY_ROLE_ARN: "arn:aws:iam::${ACCOUNT_ID}:role/${DEPLOY_ROLE_NAME}"
  NODE_VERSION: "18"
  APP_NAME: s3browser

stages:
  - build
  - deploy

default:
  tags:
    - vanilla
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.scania.com
  retry: 1

before_script:
  - echo $DEPLOY_ROLE_ARN
  - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
  - unzip awscliv2.zip
  - ./aws/install
  - aws --version
  - !reference [.assume_role]
  - apt-get update -qq && apt-get install -y -qq jq git curl
  - npm install -g @aws-amplify/cli@latest

build:
  stage: build
  script:
    # Create Amplify App
    - aws amplify create-app --name $APP_NAME --region $REGION

    # Retrieve Amplify App ID dynamically from AWS CLI
    - >
      AMPLIFY_APP_ID=$(aws amplify list-apps --region $REGION |
        jq -r ".apps[] | select(.name == \"${APP_NAME}\") | .appId") &&
      echo "Discovered AMPLIFY_APP_ID=$AMPLIFY_APP_ID" &&
      if [ -z \"$AMPLIFY_APP_ID\" ]; then
        echo "‚ùå Amplify App ID not found, exiting.";
        exit 1;
      fi &&
    # Proceed with build steps
    - npm ci
    - npx ampx generate outputs --app-id $AMPLIFY_APP_ID --branch main --profile $PROFILE_NAME || cp amplify_outputs.example.json amplify_outputs.json
    - npm run build
  artifacts:
    paths:
      - dist/
      - amplify_outputs.json
    expire_in: 1 hour

deploy:
  stage: deploy
  script:
    - npx ampx deploy --branch main
  environment:
    name: production
    url: https://s3.clad-playground.devtest.aws.scania.com
  only:
    - main
