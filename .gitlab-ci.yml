image: node:18-bullseye
include:
  - local: gitlab-ci-template.yml

variables:
  PROFILE_NAME: default
  ACCOUNT_ID: 134143989055
  DEPLOY_ROLE_NAME: team-account-deploy-role
  PARTITION: aws
  REGION: eu-north-1
  DEPLOY_ROLE_ARN: "arn:aws:iam::${ACCOUNT_ID}:role/${DEPLOY_ROLE_NAME}"
  NODE_VERSION: "18"

stages:
  - build
  - deploy

default:
  image: node:18-alpine
  before_script:
    - echo $DEPLOY_ROLE_ARN
    - !reference [.assume_role]
  tags:
    - vanilla
  id_tokens: # Support for id_tokens introduced in GitLab 16.4
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.scania.com
  retry: 1

before_script:
  - apt-get update -qq && apt-get install -y -qq git curl
  - npm install -g @aws-amplify/cli@latest

build:
  stage: build
  script:
    - npm ci
    - npx ampx generate outputs --app-id $AMPLIFY_APP_ID --branch main --profile $PROFILE_NAME || cp amplify_outputs.example.json amplify_outputs.json
    - npm run build
  artifacts:
    paths:
      - dist/
      - amplify_outputs.json
    expire_in: 1 hour

deploy:
  stage: deploy
  script:
    - npx ampx deploy --branch main
  environment:
    name: production
    url: https://s3.clad-playground.devtest.aws.scania.com
  only:
    - main
